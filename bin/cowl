#!/usr/bin/env ruby

require 'rubygems'
require 'find'
require 'optparse'
require 'dotsmack'
require 'yaml'
require 'cowl'
require 'json'

STAT_HEADER = <<-eos
{
  "statVersion": "0.4.0",
  "process": {
    "name": "Column width linter",
    "version": "#{Cowl::VERSION}",
    "description": "Helps you keep your source code / text in a terminal-friendly 80-column width",
    "maintainer": "Andrew Pennebaker",
    "email": "andrew.pennebaker@gmail.com",
    "website": "https://github.com/mcandre/cowl",
    "repeatability": "Associative"
  },
  "findings": [
eos

STAT_FOOTER = <<-eos

  ]
}
eos

def main
  ignores = DEFAULT_IGNORES

  configuration_flags = {}

  option = OptionParser.new do |option|
    option.banner = "Usage: cowl [options] [<files>|-]"

    option.on('-i', '--ignore pattern', 'Ignore file patterns (fnmatch)') do |pattern|
      ignores << pattern
    end

    option.on('-w=', '--max-width', "Maximum column width, either an integer or \"unlimited\". Default: 80") do |max_width|
      configuration_flags['max_width'] = max_width
    end

    option.on('-s', '--stat', 'Output in STAT') do
      configuration_flags['is_stat'] = true
    end

    option.on('-h', '--help', 'Print usage info') do
      puts option
      exit
    end

    option.on('-v', '--version', 'Print version info') do
      puts "cowl #{Cowl::VERSION}"
      exit
    end
  end

  option.parse!

  filenames =
    if ARGV == []
      ['-']
    else
      ARGV
    end

  dotsmack = Dotsmack::Smacker.new(
    dotignore = '.cowlignore',
    additional_ignores = ignores,
    dotconfig = '.cowlrc.yml'
  )
  finding_count = 0
  dotsmack.enumerate(filenames).each do |filename, config|
    config =
      if config.nil?
        configuration_flags
      else
        YAML.load(config).merge(configuration_flags)
      end

    if filename == '-'
      check_stdin(config) {|finding|
        finding_count = output(finding, finding_count, configuration_flags["is_stat"])
      }
    else
      check(filename, config) {|finding|
        finding_count = output(finding, finding_count, configuration_flags["is_stat"])
      }
    end
  end

  if configuration_flags["is_stat"] && finding_count > 0
    puts STAT_FOOTER
  end
end

def output(finding, finding_count, is_stat)
  if is_stat
    puts STAT_HEADER if finding_count == 0
    puts ',' if finding_count > 0
    print JSON.pretty_generate(finding).lines.map { |line| '    ' + line }.join
  end
  finding_count + 1
end

begin
  main
# User may quit before completion.
rescue Interrupt
  nil
# Bad regex
rescue RegexpError => e
  puts e
# This program may be piped to another program (e.g. `less`),
# which is quit before this program completes.
rescue Errno::EPIPE, Errno::EMFILE
  nil
end
